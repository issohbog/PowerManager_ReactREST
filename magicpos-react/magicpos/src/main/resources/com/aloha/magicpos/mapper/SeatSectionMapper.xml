<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.aloha.magicpos.mapper.SeatSectionMapper">

    <!-- 분단 목록 조회 (순서별 정렬) -->
    <select id="selectAllSections" resultType="SeatSections">
        SELECT 
            no,
            section_name,
            section_order,
            min_x,
            min_y,
            max_x,
            max_y,
            is_active
        FROM seat_sections
        WHERE is_active = TRUE
        ORDER BY section_order ASC
    </select>

    <!-- 분단 단건 조회 -->
    <select id="selectSectionById" parameterType="Long" resultType="SeatSections">
        SELECT 
            no,
            section_name,
            section_order,
            min_x,
            min_y,
            max_x,
            max_y,
            is_active
        FROM seat_sections
        WHERE no = #{no}
    </select>

    <!-- 분단 이름으로 조회 -->
    <select id="selectSectionByName" parameterType="String" resultType="SeatSections">
        SELECT 
            no,
            section_name,
            section_order,
            min_x,
            min_y,
            max_x,
            max_y,
            is_active
        FROM seat_sections
        WHERE section_name = #{sectionName}
        AND is_active = TRUE
    </select>

    <!-- 비활성 분단 이름으로 조회 -->
    <select id="selectInactiveSectionByName" parameterType="String" resultType="SeatSections">
        SELECT 
            no,
            section_name,
            section_order,
            min_x,
            min_y,
            max_x,
            max_y,
            is_active
        FROM seat_sections
        WHERE section_name = #{sectionName}
        AND is_active = FALSE
        LIMIT 1
    </select>

    <!-- 분단 생성 -->
    <insert id="insertSection" parameterType="SeatSections" useGeneratedKeys="true" keyProperty="no">
        INSERT INTO seat_sections (
            section_name,
            section_order,
            min_x,
            min_y,
            max_x,
            max_y,
            is_active
        ) VALUES (
            #{sectionName},
            #{sectionOrder},
            #{minX},
            #{minY},
            #{maxX},
            #{maxY},
            #{isActive}
        )
    </insert>

    <!-- 분단 재활성화 -->
    <update id="reactivateSection" parameterType="SeatSections">
        UPDATE seat_sections
        SET 
            section_order = #{sectionOrder},
            min_x = #{minX},
            min_y = #{minY},
            max_x = #{maxX},
            max_y = #{maxY},
            is_active = TRUE
        WHERE no = #{no}
    </update>

    <!-- 분단 수정 -->
    <update id="updateSection" parameterType="SeatSections">
        UPDATE seat_sections
        SET 
            section_name = #{sectionName},
            section_order = #{sectionOrder},
            min_x = #{minX},
            min_y = #{minY},
            max_x = #{maxX},
            max_y = #{maxY},
            is_active = #{isActive}
        WHERE no = #{no}
    </update>

    <!-- 분단 삭제 (논리 삭제) -->
    <update id="deleteSection" parameterType="Long">
        UPDATE seat_sections
        SET is_active = FALSE
        WHERE no = #{no}
    </update>

    <!-- 분단 순서 업데이트 -->
    <update id="updateSectionOrder">
        UPDATE seat_sections
        SET section_order = #{sectionOrder}
        WHERE no = #{no}
    </update>

    <!-- 분단 영역 업데이트 -->
    <update id="updateSectionBounds">
        UPDATE seat_sections
        SET 
            min_x = #{minX},
            min_y = #{minY},
            max_x = #{maxX},
            max_y = #{maxY}
        WHERE no = #{no}
    </update>

    <!-- 활성 분단 개수 조회 -->
    <select id="countActiveSections" resultType="int">
        SELECT COUNT(*)
        FROM seat_sections
        WHERE is_active = TRUE
    </select>

    <!-- 다음 순서 번호 조회 -->
    <select id="getNextSectionOrder" resultType="Integer">
        SELECT COALESCE(COUNT(*), 0) + 1
        FROM seat_sections
        WHERE is_active = TRUE
    </select>

    <!-- 분단 순서 재조정 (삭제된 순서보다 큰 순서들을 1씩 감소) -->
    <update id="reorderSectionsAfterDelete">
        UPDATE seat_sections 
        SET section_order = section_order - 1
        WHERE section_order > #{deletedOrder}
        AND is_active = TRUE
    </update>

</mapper>
