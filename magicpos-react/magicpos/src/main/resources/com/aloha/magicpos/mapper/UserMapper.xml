<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.aloha.magicpos.mapper.UserMapper">

    <resultMap id="UsersMap" type="com.aloha.magicpos.domain.Users">
        <id property="no" column="no"/>
        <result property="id" column="id"/>
        <result property="username" column="username"/>
        <result property="password" column="password"/>
        <result property="birth" column="birth"/>
        <result property="email" column="email"/>
        <result property="phone" column="phone"/>
        <result property="memo" column="memo"/>
        <result property="createdAt" column="created_at"/>
    </resultMap>

    <!-- ì „ì²´ íšŒì› ìˆ˜  -->
    <select id="countAll" resultType="int">
        SELECT COUNT(*) FROM users
    </select>

    <!-- ê²€ìƒ‰ ì¡°ê±´ì— ë§Œì¡±í•˜ëŠ” íšŒì› ìˆ˜ -->
    <select id="countBy" resultType="int">
        SELECT COUNT(*)
        FROM users
        <where>
            <choose>
                <when test="type == 'id'">
                    id LIKE CONCAT('%', #{keyword}, '%')
                </when>
                <when test="type == 'username'">
                    username LIKE CONCAT('%', #{keyword}, '%')
                </when>
            </choose>
        </where>
    </select>

    <!-- íšŒì› ì „ì²´ ì¡°íšŒ -->
    <select id="selectAll" resultMap="UsersMap">
        SELECT * FROM users
        LIMIT #{index}, #{size}
    </select>

    <!-- íšŒì› ì „ì²´ ì¡°íšŒ (ê²€ìƒ‰ê¸°ëŠ¥) -->
    <select id="searchBy" resultMap="UsersMap">
        SELECT * FROM users
        <where>
            <choose>
                <when test="type eq 'id'">
                    id LIKE CONCAT('%', #{keyword}, '%')
                </when>
                <when test="type eq 'username'">
                    username LIKE CONCAT('%', #{keyword}, '%')
                </when>
                <when test="type eq 'phone'">
                    phone LIKE CONCAT('%', #{keyword}, '%')
                </when>
            </choose>
        </where>
        ORDER BY no DESC
        LIMIT #{index}, #{size}
    </select>

    <!-- ë‹¨ì¼ íšŒì› ì¡°íšŒ -->
    <select id="selectByNo" resultMap="UsersMap" parameterType="long">
        SELECT * FROM users WHERE no = #{no}
    </select>

    <!-- ì•„ì´ë””ë¡œ íšŒì› ì¡°íšŒ - ì•„ì´ë”” ì¤‘ë³µì²´í¬ì‹œ ì‚¬ìš© -->
    <select id="findById" parameterType="String" resultType="com.aloha.magicpos.domain.Users">
        SELECT * FROM users WHERE id = #{id}
    </select>

    <!-- userNoë¡œ íšŒì› ì¡°íšŒ -->
    <select id="findByNo" parameterType="long" resultType="Users">
        SELECT * FROM users WHERE no = #{userNo}
    </select>



    <!-- íšŒì›ê°€ìž… -->
    <insert id="insert" parameterType="com.aloha.magicpos.domain.Users" useGeneratedKeys="true" keyProperty="no">
        INSERT INTO users (id, username, password, birth, email, phone, memo)
        VALUES (#{id}, #{username}, #{password}, #{birth}, #{email}, #{phone}, #{memo})
    </insert>


    <!-- ê´€ë¦¬ìžìš© íšŒì› ì •ë³´ ìˆ˜ì •(ìƒë…„ì›”ì¼, ì´ë©”ì¼, ì „í™”ë²ˆí˜¸, ë©”ëª¨) -->
    <update id="update" parameterType="com.aloha.magicpos.domain.Users">
        UPDATE users
        SET 
            username = #{username},
            gender = #{gender},
            birth = #{birth},
            email = #{email},
            phone = #{phone},
            memo = #{memo}
        WHERE no = #{no}
    </update>

    <!-- ê´€ë¦¬ìžìš© ë¹„ë°€ë²ˆí˜¸ ì´ˆê¸°í™” -->
    <update id="resetPassword">
        UPDATE users
        SET password = #{password}
        WHERE no = #{no}
    </update>

    <!-- ì‚¬ìš©ìžìš© íšŒì› ì •ë³´ ìˆ˜ì •(ë¹„ë°€ë²ˆí˜¸) -->
    <update id="updateUserProfile" parameterType="com.aloha.magicpos.domain.Users">
        UPDATE users
        SET password = #{password},
            email = #{email},
            phone = #{phone},
            birth = #{birth}
        WHERE no = #{no}
    </update>


    <!-- íšŒì› íƒˆí‡´ -->
    <delete id="delete" parameterType="long">
        DELETE FROM users WHERE no = #{no}
    </delete>

    <!-- íšŒì› ê²€ìƒ‰(ì´ë¦„/ì•„ì´ë””/ì „í™”ë²ˆí˜¸) -->
    <select id="searchUsersByKeyword" resultMap="UsersMap">
        SELECT * FROM users
        WHERE username LIKE CONCAT('%', #{keyword}, '%')
        OR id LIKE CONCAT('%', #{keyword}, '%')
        OR phone LIKE CONCAT('%', #{keyword}, '%')
    </select>



    <!-- // Java ì½”ë“œì—ì„œ ì‚¬ìš©í•  ê°’
    String defaultPassword = passwordEncoder.encode("a123456789"); -->

    <!-- ì„ ìƒë‹˜ ì½”ë“œ -->

        <resultMap id="UserMap" type="Users">
        <id property="no" column="no"/> <!-- PK -->
        
        <result property="id" column="id"/>
        <result property="username" column="username"/>
        <result property="password" column="password"/>
        <result property="birth" column="birth"/>
        <result property="gender" column="gender"/>
        <result property="email" column="email"/>
        <result property="phone" column="phone"/>
        <result property="memo" column="memo"/>
        <result property="enabled" column="enabled"/>
        <result property="createdAt" column="created_at"/>

        <!-- ðŸ”„ ê¶Œí•œ ë¦¬ìŠ¤íŠ¸ ì—°ë™ (users.no â†’ auths.u_no) -->
        <collection property="authList" ofType="Auths"
                    select="selectAuth"
                    column="no"/>
        </resultMap>

    <resultMap id="AuthMap" type="Auths">
        <result property="no" column="no" />
        <result property="uNo" column="u_no" />
        <result property="auth" column="auth" />
    </resultMap>


    <!-- íšŒì› ê°€ìž… -->
    <insert id="join" parameterType="Users"
            useGeneratedKeys="true" keyProperty="no">
        INSERT INTO users (
            id, username, password, birth, gender,
            email, phone, memo, enabled, created_at
        ) VALUES (
            #{id}, #{username}, #{password}, #{birth}, #{gender},
            #{email}, #{phone}, #{memo}, #{enabled}, NOW()
        )
    </insert>


    <!-- íšŒì› ê¶Œí•œ ë“±ë¡ -->
    <insert id="insertAuth" parameterType="Auths">
        INSERT INTO auths (u_no, auth)
        VALUES (#{uNo}, #{auth})
    </insert>


    <!-- íšŒì› ì¡°íšŒ -->
    <select id="select" resultMap="UserMap">
        SELECT *
        FROM users
        WHERE id = #{id}
    </select>

    <!-- ê¶Œí•œ ì¡°íšŒ -->
    <select id="selectAuth" parameterType="long" resultType="Auths">
        SELECT *
        FROM auths
        WHERE u_no = #{no}
    </select>




</mapper>

