<!DOCTYPE html>
<html lang="en"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layouts/user/main_layout}">
<head>
    <link rel="stylesheet" th:href="@{/css/menu.css}">
    <!-- TossPayments ê²°ì œ ìŠ¤í¬ë¦½íŠ¸ ì¶”ê°€ -->
    <script src="https://js.tosspayments.com/v1/payment"></script>
    <meta name="_csrf" th:content="${_csrf.token}"/>
    <meta name="_csrf_header" th:content="${_csrf.headerName}"/>    
</head>
<body layout:fragment="content" th:attr="data-seat-id=${usageInfo.seat_id}">
    <div class="container">
        <div class="main-panel">
            <!-- í‘œìƒ ë©”ë‰´ -->
            <div class="top-menu">
                <button class="icon-button">
                    <img th:src="@{/images/ë’¤ë¡œê°€ê¸°.png}" alt="ë’¤ë¡œê°€ê¸°">
                </button>

                <div class="menu-tabs">
                    <button th:each="category : ${categories}"
                            th:text="${category.cName}"
                            th:classappend="${category.no} == ${selectedCategory} ? 'active' : ''"
                            th:onclick="'location.href=\'/menu?selectedCategory=' + ${category.no} + '\''">
                    </button>
                </div>
                
                <button class="icon-button">
                    <img th:src="@{/images/ë‹¤ìŒí˜ì´ì§€.png}" alt="ë‹¤ìŒí˜ì´ì§€">
                </button>
                
                <form action="/menu" method="get" class="search-form">
                    <input type="text" name="keyword" placeholder="ìƒí’ˆëª… ê²€ìƒ‰">
                    <button type="submit">
                        <img th:src="@{/images/ê²€ìƒ‰.png}">
                    </button>
                </form>
            </div>
            
            <div class="product-list">
                <div class="grid-container">
                    <div th:each="product : ${products}" class="product-card">
                        <div class="product-inner">
                            <div class="product-front">
                                <img th:src="@{${product.imgPath}}" class="product-image">
                                <div class="product-info">
                                    <div th:text="${product.pName}">ìƒí’ˆëª…</div>
                                    <div th:text="${#numbers.formatInteger(product.pPrice, 3, 'COMMA') + 'ì›'}">ê°€ê²©</div>
                                </div>
                            </div>
                            <div class="product-back">
                                <div class="back-frame">
                                    <p th:text="${product.description}">ìƒí’ˆ ì„¤ëª…</p>
                                </div>
                                <!-- ì¬ê³ ê°€ ìˆì„ ë•Œë§Œ 'ë‹´ê¸°' ë²„íŠ¼ ë³´ì—¬ì£¼ê¸° -->
                                <div th:if="${product.stock > 0}">
                                    <form method="post" action="/carts/add">
                                        <input type="hidden" name="pNo" th:value="${product.no}">
                                        <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
                                        <button type="submit" class="add-cart-btn">ë‹´ê¸°</button>
                                    </form>
                                </div>

                                <!-- ì¬ê³ ê°€ 0ì´ë©´ 'í’ˆì ˆ' í‘œì‹œ -->
                                <div th:unless="${product.stock > 0}">
                                    <button class="add-cart-btn sold-out" disabled>í’ˆì ˆ</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="side-panel">
            <div class="seat-info">
                <div>ì¢Œì„ë²ˆí˜¸ <strong th:text="${usageInfo.seat_id}">50</strong></div>
                <button id="openModalBtn">ì£¼ë¬¸ë‚´ì—­ë³´ê¸°</button>
            </div>

            <!-- ì£¼ë¬¸ í¼ ì‹œì‘ -->
            <div class="cart-section">
                <div class="cart-items">
                    <div th:each="cart, cartStat : ${cartList != null ? cartList : {}}" class="cart-item">
                        <div class="cart-item-left">
                            <div th:text="${cart.p_name} ?: 'ì´ë¦„ì—†ìŒ'">ìƒí’ˆì´ë¦„</div>
                            <div class="quantity-control">
                                <!-- ìˆ˜ëŸ‰ ê°ì†Œ/ì¦ê°€/ì‚­ì œ formì€ ì£¼ë¬¸ form ë°–ì— ìœ„ì¹˜ -->
                                <form action="/carts/decrease" method="post">
                                    <input type="hidden" name="pNo" th:value="${cart.p_no}" />
                                    <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
                                    <button type="submit" class="cartcontrolBtn">
                                        <img th:src="@{/images/ë§ˆì´ë„ˆìŠ¤ í•˜ì–€ìƒ‰.png}" alt="ê°ì†Œ">
                                    </button>
                                </form>
                                <span th:text="${cart.quantity}">1</span>
                                <form action="/carts/increase" method="post">
                                    <input type="hidden" name="pNo" th:value="${cart.p_no}" />
                                    <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
                                    <button type="submit" class="cartcontrolBtn">
                                        <img th:src="@{/images/í”ŒëŸ¬ìŠ¤ ë…¸ë€ìƒ‰.png}" alt="ì¦ê°€">
                                    </button>
                                </form>
                            </div>
                        </div>
                        <div class="cart-item-right">
                            <div th:text="${(cart.p_price != null and cart.quantity != null) ? #numbers.formatInteger(cart.p_price * cart.quantity, 3, 'COMMA') + 'ì›' : '0ì›'}">ê°€ê²©</div>
                            <form action="/carts/delete" method="post">
                                <input type="hidden" name="cNo" th:value="${cart['no']}" />
                                <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
                                <button class="deleteBtn">âœ•</button>
                            </form>
                        </div>
                    </div>
                </div>
                <div class="total-price">
                    ì´ ì£¼ë¬¸ê¸ˆì•¡ <span th:text="${#numbers.formatInteger(totalPrice, 0, 'COMMA')}" style="font-weight: bold;">16,000ì›</span>
                </div>
            </div>

            <!-- ì£¼ë¬¸ í¼ì€ cart-section ì•„ë˜ì— ìœ„ì¹˜, cartList ì •ë³´ë¥¼ hidden inputìœ¼ë¡œ ì „ë‹¬ -->
            <form id="orderForm" action="/users/orders/create" method="post">
                <input type="hidden" name="seatId" th:value="${usageInfo.seat_id}" />
                <div th:each="cart, cartStat : ${cartList != null ? cartList : {}}">
                    <input type="hidden" name="pNoList" th:value="${cart.p_no}" />
                    <input type="hidden" name="quantityList" th:value="${cart.quantity}" />
                    <input type="hidden" name="pNameList" th:value="${cart.p_name}" />
                </div>
                <input type="hidden" name="totalPrice" th:value="${totalPrice}" />
                <div class="payment-methods">
                    <label><input type="radio" name="payment" value="í˜„ê¸ˆ" required>í˜„ê¸ˆ</label>
                    <label><input type="radio" name="payment" value="ì¹´ë“œ">ì¹´ë“œ</label>
                    <label><input type="radio" name="payment" value="ì¹´ì¹´ì˜¤í˜ì´">ğŸ’¬<br>QR ê²°ì œ</label>
                </div>

                <div class="cash-options">
                    <div class="cash-quick">
                        <label><input type="radio" name="cash" value="50000" class="cash-option">5ë§Œì›</label>
                        <label><input type="radio" name="cash" value="10000" class="cash-option">1ë§Œì›</label>
                        <label><input type="radio" name="cash" value="5000" class="cash-option">5ì²œì›</label>
                        <label><input type="radio" name="cash" value="1000" class="cash-option">1ì²œì›</label>
                    </div>
                    <div class="cash-custom">
                        <label><input type="radio" name="cash" value="auto" class="cash-option">ê¸ˆì•¡ì— ë§ê²Œ</label>
                        <label><input type="radio" name="cash" value="manual" class="cash-option">ì§ì ‘ ì…ë ¥</label>
                        <input type="text" name="cashManual" />
                    </div>
                </div>
                <input type="text" class="request-input" name="message" maxlength="50" placeholder="ìš”ì²­ì‚¬í•­ì€ 50ì ê¹Œì§€ ì…ë ¥í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.">
                <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
                <button class="order-button" type="button">ì£¼ë¬¸í•˜ê¸°</button>
            </form>
            <!-- ì£¼ë¬¸ í¼ ë -->
        </div>
    </div>

<!-- ìš”ê¸ˆì œ êµ¬ë§¤ ëª¨ë‹¬ -->
<div class="ticket-modal-bg fade" id="ticketModal" style="display: none;">
  <div class="ticket-modal-content">
    <!-- <th:block th:if="${ usageInfo != null && usageInfo.user_no != null }">
        <input type="hidden" id="user-no" th:value="${usageInfo.user_no} ?: ''" />
    </th:block> -->
    <input type="hidden" id="user-no" th:value="${usageInfo.user_no} ?: ''" />
    <span class="ticket-modal-close-btn" onclick="closeTicketModal()">Ã—</span>
    <div class="ticket_con">
      <h2>ìš”ê¸ˆì œ êµ¬ë§¤</h2>
      <div class="plan-grid">
        <div class="plan-card" 
             th:each="ticket : ${ticketList}"
             th:data-name="'íšŒì› ' + ${ticket.price} + 'ì›ê¶Œ'"
             th:data-price="${ticket.price}"
             th:data-time="${ticket.time}"
             th:data-ticket-no="${ticket.no}"
             >
          <div class="plan-title" th:text="'íšŒì› ' + ${#numbers.formatInteger(ticket.price, 0)} + 'ì›ê¶Œ'"></div>
          <div class="plan-info">
            <div class="plan-time" th:text="${ticket.time} + ':00'">00:00</div>
            <div class="plan-price" th:text="${#numbers.formatInteger(ticket.price, 0)} + 'ì›'">1,000ì›</div>
          </div>
        </div>
      </div>
    </div>
    <div class="ticket-modal-side">
        <div class="ticket-section">
            <div class="ticket-item">    
            </div>
        </div>
        <button class="ticket-payment-btn" type="submit">ê²°ì œí•˜ê¸°</button>
    </div>
  </div>
</div>

<!-- ì¢Œì„ ì„ íƒ ëª¨ë‹¬ -->
<div class="seat-modal-bg fade" id="seatModal" style="display: none;">
  <div class="seat-modal-content">
    <span class="seat-modal-close-btn" onclick="closeSeatModal()">Ã—</span>
    <h2>ì¢Œì„ ì„ íƒ</h2>
    <div class="seat-grid" id="seatGrid">
      <!-- S1~S34 ë²„íŠ¼ì´ JSë¡œ ë™ì ìœ¼ë¡œ ìƒì„±ë¨ -->
    </div>
    <button id="seatSelectBtn" disabled>ì¢Œì„ ì„ íƒ ì™„ë£Œ</button>
  </div>
</div>

<!-- í† ìŠ¤í˜ì´ë¨¼ì¸  ìŠ¤í¬ë¦½íŠ¸ ì¶”ê°€ -->
<script th:inline="javascript">
    const clientKey = "test_ck_ZLKGPx4M3MGPnBZkRAlwrBaWypv1"; // í…ŒìŠ¤íŠ¸ìš© client key
    const tossPayments = TossPayments(clientKey);

    // ì¢Œì„ ì„ íƒ ëª¨ë‹¬ ê´€ë ¨ ìŠ¤í¬ë¦½íŠ¸
    document.addEventListener('DOMContentLoaded', function() {
      // ì¢Œì„ ë¯¸ì„ íƒ ìƒíƒœë¼ë©´ ëª¨ë‹¬ ìë™ ë…¸ì¶œ
      var seatId = document.body.dataset.seatId;
      if (!seatId) {
        document.getElementById('seatModal').style.display = 'block';
        loadReservedSeats();
      }
    });

    function closeSeatModal() {
      document.getElementById('seatModal').style.display = 'none';
    }

    // ì¢Œì„ ë²„íŠ¼ ë™ì  ìƒì„± ë° ì˜ˆì•½ì¢Œì„ ë¹„í™œì„±í™”
    function loadReservedSeats() {
      fetch('/api/seats/reserved')
        .then(res => res.json())
        .then(data => {
          const reserved = data.reservedSeats || [];
          const seatGrid = document.getElementById('seatGrid');
          seatGrid.innerHTML = '';
          for (let i = 1; i <= 34; i++) {
            const seatId = 'S' + i;
            const btn = document.createElement('button');
            btn.textContent = seatId;
            btn.className = 'seat-btn';
            if (reserved.includes(seatId)) {
              btn.disabled = true;
              btn.classList.add('reserved');
            }
            btn.onclick = function() {
              document.querySelectorAll('.seat-btn').forEach(b => b.classList.remove('selected'));
              btn.classList.add('selected');
              document.getElementById('seatSelectBtn').disabled = false;
              document.getElementById('seatSelectBtn').dataset.seatId = seatId;
            };
            seatGrid.appendChild(btn);
          }
        });
    }

    // ì¢Œì„ ì„ íƒ ì™„ë£Œ ë²„íŠ¼ í´ë¦­ ì‹œ ì„œë²„ë¡œ ì˜ˆì•½ ìš”ì²­
    document.getElementById('seatSelectBtn').onclick = function() {
      const seatId = this.dataset.seatId;
      fetch('/api/seats/reserve', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRF-TOKEN': document.querySelector('meta[name="_csrf"]').content
        },
        body: JSON.stringify({ seatId: seatId })
      })
      .then(res => res.json())
      .then(data => {
        if (data.success) {
          location.reload();
        } else {
          alert(data.message || 'ì¢Œì„ ì˜ˆì•½ ì‹¤íŒ¨');
          loadReservedSeats();
        }
      });
    };
</script>

<!-- ìš”ê¸ˆì œ êµ¬ë§¤ ëª¨ë‹¬ ë -->

<!-- ê²°ì œ ì™„ë£Œ ëª¨ë‹¬ -->
<div class="paysucc-modal-bg fade" id="paymentSuccessModal" style="display: none;">
  <div class="paysucc-modal-content">
    <div class="paysucc-modal-body">
    <img th:src="@{/images/clock.png}">
      <h3>ìš”ê¸ˆì œ êµ¬ë§¤ê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.</h3>
      <p>ì”ì—¬ ì´ìš© ì‹œê°„ì´ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.<br>ì¦ê±°ìš´ ì´ìš© ë˜ì„¸ìš”!</p>
    </div>
    <div class="paysucc-modal-footer">
      <button onclick="closeAllModals()">í™•ì¸</button>
    </div>
  </div>
</div>
    <script th:src="@{/js/userscript.js}"></script>
        <script>
        document.addEventListener("DOMContentLoaded", () => {
        const btn = document.getElementById("openTicketBtn");
        if (btn) {
            btn.addEventListener("click", () => {
            const modal = document.getElementById("ticketModal");
            modal.style.display = "flex";
            modal.classList.remove("fade-out");
            });
        } else {
            console.log("ë²„íŠ¼ ë˜ëŠ” ëª¨ë‹¬ì´ ì—†ìŠµë‹ˆë‹¤. ", btn, modal);
        }
        });
    </script>


    <script>
        // ìš”ê¸ˆì œ ê²°ì œ ì™„ë£Œ ëª¨ë‹¬ ì—´ê³  ë‹«ê¸° 
        function showPaymentSuccessModal() {
            document.getElementById("paymentSuccessModal").style.display = "flex";
            document.getElementById("paymentSuccessModal").classList.remove("fade-out");
        }
    </script>

    <script>
        // ëª¨ë“  ëª¨ë‹¬ ë‹«ê¸° (ìš”ê¸ˆì œ êµ¬ë§¤ + ê²°ì œ ëª¨ë‹¬ ë‘˜ë‹¤)
        function closeAllModals() {
            const modals = [document.getElementById("paymentSuccessModal"), document.getElementById("ticketModal")];

            modals.forEach(modal => {
                // fade-out í´ë˜ìŠ¤ ì¶”ê°€
                modal.classList.add("fade-out");

                // íŠ¸ëœì§€ì…˜ ëë‚˜ë©´ display: none ì²˜ë¦¬
                modal.addEventListener("transitionend", function handler() {
                modal.style.display = "none";
                modal.classList.remove("fade-out");
                modal.removeEventListener("transitionend", handler); // ì¤‘ë³µ ë°©ì§€
                });
            });
        }
    </script>

    <script th:inline="javascript">
    window.orderSuccess = [[${orderSuccess}]];
    </script>
    <script th:if="${error}" th:inline="javascript">
        alert([[${error}]]);
    </script>

    <script th:inline="javascript">
    const userNo = /*[[${usageInfo.user_no}]]*/ null;
    </script>

    <!-- ê²°ì œ js -->
    <script>
    document.addEventListener('DOMContentLoaded', () => {
    const orderForm = document.getElementById('orderForm');
    const orderBtn = orderForm.querySelector('.order-button');
    const csrfToken = document.querySelector('meta[name="_csrf"]').getAttribute('content');
    const csrfHeader = document.querySelector('meta[name="_csrf_header"]').getAttribute('content');
    const tossPayments = TossPayments("test_ck_ZLKGPx4M3MGPnBZkRAlwrBaWypv1");

    orderBtn.addEventListener('click', async function (e) {
        e.preventDefault(); // ê¸°ì¡´ í¼ ì œì¶œ ë§‰ê¸°

        const paymentMethod = document.querySelector('input[name="payment"]:checked')?.value;
        const selectedCash = document.querySelector('input[name="cash"]:checked')?.value;
        const manualInput = document.querySelector('input[name="cashManual"]');
        if (!paymentMethod) {
        alert("ê²°ì œ ìˆ˜ë‹¨ì„ ì„ íƒí•´ì£¼ì„¸ìš”.");
        return;
        }

        // í˜„ê¸ˆì¸ë° ì•„ë¬´ ê¸ˆì•¡ë„ ì„ íƒ ì•ˆ í–ˆì„ ë•Œë„ ë§‰ì•„ì£¼ê¸°
        if (paymentMethod === 'í˜„ê¸ˆ' && !selectedCash) {
            e.preventDefault();
            alert('ê²°ì œ ê¸ˆì•¡ì„ ì„ íƒí•´ì£¼ì„¸ìš”!');
            return;
        }
        // "ì§ì ‘ ì…ë ¥" ì„ íƒí–ˆëŠ”ë° ê°’ì´ ì—†ìœ¼ë©´ ë§‰ì•„ì£¼ê¸°
        if (paymentMethod === 'í˜„ê¸ˆ' && selectedCash === 'manual') {
            if (!manualInput.value || manualInput.value.trim() === '') {
                e.preventDefault(); // ì œì¶œ ë§‰ê¸°
                alert('ê¸ˆì•¡ì„ ì…ë ¥í•´ì£¼ì„¸ìš”!');
                manualInput.focus();
                return;
            }
        }
        if (paymentMethod === "í˜„ê¸ˆ") {
        orderForm.submit();
        return;
        }

        const seatId = orderForm.querySelector('input[name="seatId"]').value;
        const totalPrice = orderForm.querySelector('input[name="totalPrice"]').value;
        const pNos = [...orderForm.querySelectorAll('input[name="pNoList"]')].map(el => el.value);
        const quantities = [...orderForm.querySelectorAll('input[name="quantityList"]')].map(el => el.value);
        const pNames = [...orderForm.querySelectorAll('input[name="pNameList"]')].map(el => el.value);

        try {
        // âœ… 1. ì„¸ì…˜ì— ì£¼ë¬¸ ë°ì´í„° ë¯¸ë¦¬ ì €ì¥
        await fetch('/users/orders/temp', {
            method: 'POST',
            headers: {
            'Content-Type': 'application/json',
            [csrfHeader]: csrfToken
            },
            body: JSON.stringify({
            seatId,
            pNoList: pNos,
            quantityList: quantities,
            pNameList: pNames,
            totalPrice,
            payment: paymentMethod,
            userNo
            })
        });

        // âœ… 2. ê²°ì œ ì •ë³´ ìš”ì²­
        const res = await fetch('/users/orders/payment-info', {
            method: 'POST',
            headers: {
            'Content-Type': 'application/json',
            [csrfHeader]: csrfToken
            },
            body: JSON.stringify({
            seatId,
            pNoList: pNos,
            quantityList: quantities,
            pNameList: pNames,
            totalPrice,
            payment: paymentMethod,
            userNo 
            })
        });

        if (!res.ok) {
            alert("ê²°ì œ ì •ë³´ ìš”ì²­ ì‹¤íŒ¨");
            return;
        }

        const paymentInfo = await res.json();

        tossPayments.requestPayment(paymentMethod, {
            amount: paymentInfo.amount,
            orderId: paymentInfo.orderId,
            orderName: paymentInfo.orderName,
            customerName: paymentInfo.customerName,
            successUrl: paymentInfo.successUrl,
            failUrl: paymentInfo.failUrl
        });

        } catch (err) {
        console.error("ê²°ì œ ì¤‘ ì˜¤ë¥˜ ë°œìƒ!", err);
        alert("ê²°ì œ ë„ì¤‘ ë¬¸ì œê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
        }
    });
    });
</script>

<script>
document.addEventListener("DOMContentLoaded", function() {
    // ì„œë²„ì—ì„œ ë°›ì•„ì˜¨ ë¶„ ë‹¨ìœ„ ê°’ì„ ì´ˆë¡œ ë³€í™˜
    let usedTimeEl = document.getElementById('usedTime');
    let remainTimeEl = document.getElementById('remainTime');

    let usedSeconds = parseInt(usedTimeEl.dataset.usedMin, 10) * 60;
    let remainSeconds = parseInt(remainTimeEl.dataset.remainMin, 10) * 60;

    function pad(n) { return n < 10 ? '0' + n : n; }

    function formatTime(seconds) {
        const hrs = Math.floor(seconds / 3600);
        const mins = Math.floor((seconds % 3600) / 60);
        const secs = seconds % 60;
        return `${pad(hrs)}:${pad(mins)}:${pad(secs)}`;
    }

    function updateTimes() {
        usedTimeEl.textContent = formatTime(usedSeconds);
        remainTimeEl.textContent = remainSeconds > 0 ? formatTime(remainSeconds) : "ë§Œë£Œë¨";
        usedSeconds++;
        if (remainSeconds > 0) remainSeconds--;
    }

    updateTimes(); // ìµœì´ˆ ì‹¤í–‰
    setInterval(updateTimes, 1000); // 1ì´ˆë§ˆë‹¤ ê°±ì‹ 
});
</script>


</body>
</html>